<html>
    <head>
        <title>文本-二维码半自动转换器</title>
        <meta http-equiv="content-type" content="text/html; charset=utf-8" />
        <link rel="stylesheet" href="css/jquery-ui.min.css" />
        <script type="text/javascript" src="js/jquery.min.js"></script>
        <script type="text/javascript" src="js/jquery-ui.min.js"></script>
        <script type="text/javascript" src="js/jquery.qrcode.js"></script>
        <script type="text/javascript" src="js/lzstring-1.3.0.js"></script>
        <script type="text/javascript" src="js/qrcode.js"></script>
        <script type="text/javascript" src="js/aes.js"></script>
        <script type="text/javascript" src="js/crc32.js"></script>
        <script>
        var text2code = {
            
            handlers: {
                beforeAccordionActivated: function(e,ui){
                    if(ui.newPanel.attr('name') == 'result'){
                        text2code.update(
                            ui.oldPanel.find('[name="input-data"]').val(),
                            ui.oldPanel.find('[name="encrypt-password"]').val()
                        );
                    }
                },
            },

            update: function(data, password){
//                data = LZString.compress(data)

                /************************************************************/
                var ciphertext = GibberishAES.enc(data, password);
                ciphertext = ciphertext.replace(/[^0-9a-zA-Z\+\/=]/g, '');
                text2code.split(ciphertext, 300);
            },

            split: function(ciphertext, length){
                var blocks = [];
                var text_id = crc32(ciphertext).toString(16);

                while(ciphertext != ''){
                    blocks.push(ciphertext.substring(0, length));
                    ciphertext = ciphertext.substring(length);
                }
                
                for(var i=0; i<blocks.length; i++){
                    blocks[i] = ")" + i + ")" + blocks[i] + "(" + text_id + "p" + blocks.length + "(";
                }

                //draw QR codes
                var output_region = $('#text-code [name="result"]').empty();
                for(var i in blocks)
                    output_region.append(
                        $('<div>')
                            .addClass('qrcode')
                            .data('qrdata', blocks[i])
                    );

                text2code.qrcodize();
            },

            qrcodize: function(){
                $('.qrcode').each(function(){
                    $(this).qrcode({
                        'text': $(this).data('qrdata'),
                    });
                });
            },

        };

        var code2text = {

            _found: {},

            feed: function(chaos){
                chaos = chaos.replace(/[^\(\)0-9a-zA-Z\+\/=]/g, '');
                var regel = /\)(\d+)\)([0-9a-zA-Z\+\/=]+)\(([0-9a-f]+)p(\d+)\(/g; 
                
                while(true){
                    var result = regel.exec(chaos);

                    if(result){
                        var main_index = result[3] + '.' + result[4];
                        if(code2text._found[main_index] == undefined){
                            code2text._found[main_index] = {
                                'count': result[4],
                                'crc32': result[3],
                                'full': false,
                                'pieces': {},
                            };
                        }
                        code2text._found[main_index]['pieces'][result[1]]
                            = result[2];
                    } else
                        break;
                }

                for(var text_id in code2text._found){
                    var collector = code2text._found[text_id];
                    if(collector.full) continue;

                    var keys = [];
                    for(var key in collector.pieces) keys.push(key);
                    if(keys.length != collector.count) continue;
                    keys.sort();
                
                    var joined = '';
                    for(var i in keys) joined += collector.pieces[i];

                    if(crc32(joined).toString(16) == collector.crc32){
                        code2text._found[text_id].full = joined;
                        code2text.handlers.codeReadFull(text_id);
                    } else
                        alert('Schade!' + joined.length);
                }

            },

            reset: function(){
                code2text._found = {};
            },

            handlers: {

                codeReadFull: function(text_id){
                    alert(code2text._found[text_id].full);
                },

                onReadClicked: function(){
                    var target = $('#code-text [name="pastebin"]');
                    var feeded = target.val();
                    target.val('');
                    code2text.feed(feeded);
                },

                onClearClicked: function(){
                    $('#code-text [name="pastebin"]').val('');
                },

            },

        };

        $(function(){
            $('.tabs').tabs();
            $('button').button();
            $('.accordion').accordion({
                beforeActivate: text2code.handlers.beforeAccordionActivated,
            });

            $('#code-text button[name="read"]').click(
                code2text.handlers.onReadClicked
            );

            $('#code-text button[name="clear"]').click(
                code2text.handlers.onClearClicked
            );

            $('#code-text button[name="reset"]').click(code2text.reset);
        })
        </script>
        <style>
            .qrcode{
                padding: 10px;
                display: inline-block;
            }
        </style>
    </head>
    <body>
        <div name="desc">
            <p>文本到二维码转换器，可用于将文本数据进行加密、编码后拆分成若干包，在网页上绘制出多个二维码。
            这些二维码只要出现在同一图片内，且未经大的压缩，就仍然可以被识别出来，然后重组得到数据。
            在传输二维码时，二维码的顺序和重复不重要。您可以直接用截图工具截取屏幕上显示的全部二维码，然后发出即可。
            </p>
        </div>
        <div class="tabs">
            <ul>
                <li><a href="#text-code">文本到二维码图片转换</a></li>
                <li><a href="#code-text">二维码图片识别结果解析</a></li>
            </ul>
            <div id="text-code">
                <p>本页面使用JavaScript绘制二维码，有图形和表格模式输出可选。
                前者适合于需要将多个复杂的二维码展示在同一页面上时，后者支持Ctrl+滚轮缩放，但是性能较差。</p>
                <div class="accordion">
                    <h3>输入要处理的文本数据</h3>
                    <div>
                        <div>
                            <label for="encrypt-password">对称加密密码</label>
                            <input type="password" name="encrypt-password" />
                        </div>
                        <div>
                        <div><label for="input-data">要处理的文本数据</label></div>
                        <textarea name="input-data" style="width: 100%" rows="10"></textarea>
                        </div>
                    </div>

                    <h3>复制二维码图片结果</h3>
                    <div name="result">
                    </div>
                </div>
            </div>
            <div id="code-text">
                <p>本页面不能识别二维码。因此，您需要将收集到的二维码图片用程序zbarimg识别。识别的批量结果直接粘贴到这个页面，即可自动整理得到输出。</p>
                <p>如果您需要将多个图片的结果组合起来，可以将多个图片的识别结果一起粘贴进来。
                您也可以在每个图片识别之后就粘贴。只要您没有按“复位”，程序会等待您的全部输入结果。</p>
                <div>
                    <div><label for="pastebin">将识别结果粘贴到下面的框中：</label></div>
                    <textarea name="pastebin" style="width: 100%" rows="5"></textarea>
                    <div>
                        <button type="button" name="read">读取识别结果</button>
                        <button type="button" name="clear">清空识别结果收集框</button>
                        <button class="ui-state-error" type="button" name="reset">复位！删除已经输入的全部数据</button>
                    </div>

                </div>
            </div>
        </div>


    </body>
</html>
